"use strict";const e=require("../common/vendor.js"),a=require("../utils/require.js");if(require("../config.js"),!Array){e.resolveComponent("uni-popup")()}Math;const o={__name:"LoginPopup",emits:["success","close"],setup(o,{expose:t,emit:n}){const r=n,s=e.ref(null),u=e.ref(!1),l=e.ref(!1),c=e.ref(1),i=e.ref(""),d=e=>{l.value=e.detail.value.length>0},v=()=>{e.index.navigateTo({url:"/pages/agreement/privacy"})},p=()=>{e.index.navigateTo({url:"/pages/agreement/user"})},f=async()=>{if(l.value)try{u.value=!0;const o=await e.index.login({provider:"weixin"}),t=await a.request({url:"/auth/login",method:"POST",data:{code:o.code}});201===t.data.code&&t.data.data.access_token&&(i.value=t.data.data.access_token,e.index.setStorageSync("token",i.value),c.value=2)}catch(o){console.error("登录错误",o),e.index.showToast({title:"登录失败",icon:"error"})}finally{u.value=!1}else e.index.showToast({title:"请先同意用户协议和隐私政策",icon:"none"})},g=async()=>{try{u.value=!0;const o=await e.index.getUserProfile({desc:"用于完善用户资料"}),t=await(async e=>{try{const o=await a.request({url:"/auth/update-userinfo",method:"POST",data:e});return 200===o.data.code||201===o.data.code?o.data.data:null}catch(o){return console.error("更新用户信息失败",o),null}})(o.userInfo);r("success",{token:i.value,user:t||o.userInfo}),m(),e.index.showToast({title:"登录成功",icon:"success"})}catch(o){console.error("获取用户信息失败",o),h()}finally{u.value=!1}},h=()=>{r("success",{token:i.value,user:null}),m()},m=()=>{c.value=1,i.value="",s.value.close(),r("close")};return t({open:()=>{s.value.open()}}),(a,o)=>e.e({a:1===c.value},1===c.value?{b:l.value,c:e.o(v),d:e.o(p),e:e.o(d),f:e.o(f),g:u.value,h:!l.value,i:l.value?"":1}:{j:e.o(g),k:u.value,l:e.o(h)},{m:e.sr(s,"6fa65603-0",{k:"popup"}),n:e.p({type:"bottom","background-color":"#fff"})})}},t=e._export_sfc(o,[["__scopeId","data-v-6fa65603"]]);wx.createComponent(t);
