"use strict";const e=require("../common/vendor.js"),a=require("../utils/require.js");if(require("../config.js"),!Array){e.resolveComponent("uni-popup")()}Math;const o={__name:"LoginPopup",emits:["success","close"],setup(o,{expose:t,emit:s}){const n=s,r=e.ref(null),u=e.ref(!1),l=e.ref(!1),c=e.ref(1),i=e.ref(""),d=e=>{l.value=e.detail.value.length>0},v=()=>{e.index.navigateTo({url:"/pages/agreement/user"})},f=async()=>{var o,t;if(l.value)try{u.value=!0;const s=await e.index.login({provider:"weixin"}),r=await a.request({url:"/auth/login",method:"POST",data:{code:s.code}});201===r.data.code&&r.data.data.access_token&&(i.value=r.data.data.access_token,e.index.setStorageSync("token",i.value),(null==(o=r.data.data.user)?void 0:o.nickname)&&(null==(t=r.data.data.user)?void 0:t.avatarUrl)?(n("success",{token:i.value,user:r.data.data.user}),h()):c.value=2)}catch(s){console.error("登录错误",s),e.index.showToast({title:"登录失败",icon:"error"})}finally{u.value=!1}else e.index.showToast({title:"请先同意用户协议和隐私政策",icon:"none"})},p=async()=>{try{u.value=!0;const o=await e.index.getUserProfile({desc:"用于完善用户资料"});console.log("微信返回的用户信息：",o.userInfo);const t=await(async e=>{try{const o=await a.request({url:"/auth/update-userinfo",method:"POST",data:e});return 200===o.data.code||201===o.data.code?o.data.data:null}catch(o){return console.error("更新用户信息失败",o),null}})(o.userInfo);n("success",{token:i.value,user:t||o.userInfo}),h(),e.index.showToast({title:"登录成功",icon:"success"})}catch(o){console.error("获取用户信息失败",o),g()}finally{u.value=!1}},g=()=>{n("success",{token:i.value,user:null}),h()},h=()=>{c.value=1,i.value="",r.value.close(),n("close")};return t({open:()=>{r.value.open()}}),(a,o)=>e.e({a:1===c.value},1===c.value?{b:l.value,c:e.o(v),d:e.o(d),e:e.o(f),f:u.value,g:!l.value,h:l.value?"":1}:{i:e.o(p),j:u.value,k:e.o(g)},{l:e.sr(r,"2aab9af9-0",{k:"popup"}),m:e.p({type:"bottom","background-color":"#fff"})})}},t=e._export_sfc(o,[["__scopeId","data-v-2aab9af9"]]);wx.createComponent(t);
