"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/require.js");require("../../config.js");const a={__name:"deviceSearch",setup(a){const c=e.ref([]),i=e.ref("searching"),s=e.ref(!1),n=()=>{e.index.openBluetoothAdapter({success:e=>{console.log("蓝牙初始化成功",e),t()},fail:o=>{console.error("蓝牙初始化失败",o),i.value="failed",e.index.showToast({title:"请开启蓝牙",icon:"none"})}})},t=()=>{e.index.startBluetoothDevicesDiscovery({allowDuplicatesKey:!1,success:e=>{console.log("开始搜索蓝牙设备",e),d()},fail:e=>{console.error("搜索蓝牙设备失败",e),i.value="failed"}})},d=()=>{e.index.onBluetoothDeviceFound((e=>{e.devices.forEach((e=>{e.name&&!c.value.some((o=>o.deviceId===e.deviceId))&&c.value.push({name:e.name,deviceId:e.deviceId,RSSI:e.RSSI,advertisData:e.advertisData})}))}))},l=()=>{e.index.stopBluetoothDevicesDiscovery({success:e=>{console.log("停止搜索蓝牙设备",e)}})},r=o=>new Promise(((a,c)=>{e.index.createBLEConnection({deviceId:o.deviceId,timeout:1e4,success:e=>{console.log("连接蓝牙设备成功",e),a(e)},fail:e=>{console.error("连接蓝牙设备失败",e),c(e)}})})),u=async e=>{try{const a=await o.request({url:"/devices",method:"POST",data:{device_model:e.deviceId,device_name:e.name}});return 200===a.data.code||201===a.data.code}catch(a){throw console.error("保存设备信息到服务器失败",a),a}},v=()=>{s.value=!0,c.value=[],i.value="searching",n()},h=()=>{e.index.navigateTo({url:"/pages/contactCostumer/contactCostumer"})};return e.onMounted((()=>{n()})),e.onUnmounted((()=>{l(),e.index.closeBluetoothAdapter()})),(o,a)=>e.e({a:e.f(c.value,((o,a,c)=>({a:e.t(o.name),b:a,c:e.o((a=>(async o=>{try{l(),await r(o),await u(o),i.value="success",e.index.showToast({title:"绑定成功",icon:"success"}),e.index.navigateTo({url:"/pages/deviceBindSuccess/deviceBindSuccess"})}catch(a){console.error("绑定失败",a),i.value="failed",e.index.showToast({title:"绑定失败",icon:"error"})}})(o)),a)}))),b:"pending"===i.value||"failed"===i.value},"pending"===i.value||"failed"===i.value?{c:e.o(v)}:{},{d:s.value&&("pending"===i.value||"failed"===i.value)},!s.value||"pending"!==i.value&&"failed"!==i.value?{}:{e:e.o(h)})}};wx.createPage(a);
