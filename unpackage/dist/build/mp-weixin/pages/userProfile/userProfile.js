"use strict";const e=require("../../common/vendor.js"),a=require("../../api/userRelations.js"),t=require("../../api/points.js"),i=require("../../api/moments.js"),o=require("../../utils/eventBus.js"),n=require("../../utils/require.js");require("../../config.js");const s={__name:"userProfile",props:{userId:{type:String,required:!0}},setup(s){const l=e.ref(""),r=e.ref("dynamics"),u=e.ref(!1),c=e.ref(!1),d=e.ref(1),v=e.ref(20),g=e.ref({id:"",nickname:"",avatar:"",bio:"",followingCount:0,followersCount:0,points:0,isFollowing:!1,isBlocked:!1,gender:0,city:"",province:"",birthday:"",weight:0,height:0,target:0}),m=e.ref([]),w=e.ref([]),h=e=>{r.value=e,d.value=1,y()},p=async()=>{try{const e=await n.request({url:`/users/${l.value}/profile`});if(200===e.data.code){const a=e.data.data;g.value={id:a._id,nickname:a.nickname||"未设置昵称",avatar:a.avatarUrl,bio:a.bio||"这个人很懒，没有签名",followingCount:a.following>=0?a.following:0,followersCount:a.followers||0,points:a.points||0,isFollowing:a.isFollowing,isBlocked:a.isBlocked,gender:a.gender,city:a.city,province:a.province,birthday:a.birthday,weight:a.weight,height:a.height,target:a.target}}}catch(a){console.error("获取用户信息失败:",a),e.index.showToast({title:"获取用户信息失败",icon:"none"})}},f=e.ref(0);e.onLoad((e=>{e.id&&(l.value=e.id)}));const y=async()=>{console.log(r.value),"dynamics"===r.value&&await k()},k=async()=>{if(!u.value){u.value=!0;try{const a={page:d.value,limit:v.value},t=await i.momentApi.getMoments(a),o=JSON.parse(e.index.getStorageSync("userInfo"))._id;if(200===t.data.code){const e=t.data.data.items.map((e=>{var a,t;return{id:e._id,content:e.content,createTime:new Date(e.createdAt).toLocaleDateString("zh-CN"),images:e.images||[],isLiked:null==(a=e.likedBy)?void 0:a.includes(o),likes:e.likeCount,comments:e.commentCount,shares:0,sportData:null==(t=e.metadata)?void 0:t.sportData}}));1===d.value?m.value=e:m.value=[...m.value,...e],d.value++}}catch(a){console.error("获取动态列表失败:",a),e.index.showToast({title:"获取动态列表失败",icon:"none"})}finally{u.value=!1,c.value=!1}}},x=a=>{e.index.navigateTo({url:`/pages/swimmerDetail/swimmerDetail?id=${a}`})},b=async()=>{try{g.value.isFollowing?await a.userRelationsApi.unfollowUser(l.value):await a.userRelationsApi.followUser(l.value),g.value.isFollowing=!g.value.isFollowing,p(),o.emitter.emit("updateFollowingList"),e.index.showToast({title:g.value.isFollowing?"关注成功":"取消关注成功",icon:"success"})}catch(t){console.error("操作失败:",t),e.index.showToast({title:"操作失败",icon:"none"})}},T=()=>{c.value=!0,d.value=1,y()},q=()=>{y()};return e.onMounted((()=>{p(),(async()=>{try{const e=await t.pointApi.getUserPoints();200===e.data.code&&(f.value=e.data.data.totalPoints)}catch(e){}})(),y()})),(a,t)=>e.e({a:g.value.avatar||"/static/avatar.png",b:e.t(g.value.nickname),c:e.t(g.value.bio||"简介XXXXXXXXXXXX"),d:e.t(g.value.followingCount||0),e:e.t(g.value.followersCount||0),f:e.t(f.value||0),g:e.t(g.value.isFollowing?"已关注":"关注"),h:g.value.isFollowing?1:"",i:e.o(b),j:"dynamics"===r.value},(r.value,{}),{k:"dynamics"===r.value?1:"",l:e.o((e=>h("dynamics"))),m:"badges"===r.value},(r.value,{}),{n:"badges"===r.value?1:"",o:e.o((e=>h("badges"))),p:"dynamics"===r.value},"dynamics"===r.value?e.e({q:m.value.length>0},m.value.length>0?{r:e.f(m.value,((a,t,o)=>e.e({a:e.t(a.createTime),b:e.t(a.content),c:a.images&&a.images.length>0},a.images&&a.images.length>0?{d:e.f(a.images,((t,i,o)=>({a:t,b:i,c:e.o((t=>((a,t)=>{e.index.previewImage({current:t,urls:a})})(a.images,i)),i)}))),e:e.n(1===a.images.length?"single-image":""),f:e.n(4===a.images.length?"four-grid":""),g:e.n(a.images.length>4?"multi-grid":"")}:{},{h:a.sportData},a.sportData?{i:e.t(a.sportData.distance),j:e.t(a.sportData.duration),k:e.t(a.sportData.pace),l:e.t(a.sportData.calories)}:{},{m:e.o((e=>x(a.id)),t),n:a.isLiked?"/static/icons/moments-like-active.png":"/static/icons/moments-like.png",o:e.t(a.likes),p:e.o((t=>(async a=>{try{const e=await i.momentApi.likeMoment(a.id);if(201===e.data.code){const{liked:t}=e.data.data;m.value=m.value.map((e=>e.id===a.id?{...e,likes:e.likes+(t?1:-1),isLiked:t}:e))}}catch(t){console.error("点赞操作失败:",t),e.index.showToast({title:t.message||"操作失败",icon:"none"})}})(a)),t),q:e.t(a.comments),r:e.o((e=>x(a.id)),t),s:e.t(a.shares),t:e.o((a=>{e.index.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]})}),t),v:e.o((t=>(a=>{const t=JSON.parse(e.index.getStorageSync("userInfo"))._id,o=a.authorId===t,n=o?["删除"]:["举报"];e.index.showActionSheet({itemList:n,success:async function(t){if(o&&0===t.tapIndex)try{200===(await i.momentApi.deleteMoment(a.id)).data.code&&(m.value=m.value.filter((e=>e.id!==a.id)),e.index.showToast({title:"删除成功",icon:"success"}))}catch(n){console.error("删除动态失败:",n),e.index.showToast({title:"删除失败",icon:"none"})}else o||0!==t.tapIndex||e.index.showToast({title:"举报成功",icon:"success"})}})})(a)),t),w:t}))),s:g.value.avatar||"/static/avatar.png",t:e.t(g.value.nickname)}:{}):{},{v:"badges"===r.value},"badges"===r.value?e.e({w:w.value.length>0},w.value.length>0?{x:e.f(w.value,((e,a,t)=>({a:a})))}:{}):{},{y:u.value},(u.value,{}),{z:e.o(q),A:c.value,B:e.o(T)})}};wx.createPage(s);
