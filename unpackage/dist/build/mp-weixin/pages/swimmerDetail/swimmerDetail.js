"use strict";const e=require("../../common/vendor.js"),t=require("../../api/moments.js"),a=require("../../api/comments.js"),o=require("../../api/userRelations.js"),i=require("../../utils/eventBus.js");require("../../utils/require.js"),require("../../config.js");const n={__name:"swimmerDetail",setup(n){const s=e.ref({}),l=e.ref(""),r=e.ref(!1),c=e.ref([]);e.ref(1),e.ref(!1),e.ref(!0);const u=e.ref(""),m=e.ref(!1),d=e.ref(null),v=async t=>{try{const e=await a.commentsApi.getComments(t);200===e.data.code&&(c.value=e.data.data,c.value.forEach((e=>{console.log(e.author.nickname)})))}catch(o){e.index.showToast({title:"获取评论失败",icon:"none"})}},h=async()=>{if(u.value.trim())try{let t;d.value&&d.value._id?(console.log(d.value._id),t=await a.commentsApi.replyComment(d.value._id,{content:u.value})):t=await a.commentsApi.createComment(s.value.id,{content:u.value}),201===t.data.code&&(await v(s.value.id),u.value="",d.value=null,s.value.comments++,e.index.showToast({title:"发送成功",icon:"success"}))}catch(t){e.index.showToast({title:"发送失败",icon:"none"})}},w=()=>{const t=JSON.parse(e.index.getStorageSync("userInfo"))._id;console.log(s.value);const a=s.value.authorId===t,o=a?["删除"]:["举报","不感兴趣"];e.index.showActionSheet({itemList:o,success:async function(t){if(a){if(0===t.tapIndex)try{await g(s.value.id)}catch(o){console.error("删除动态失败:",o)}}else switch(t.tapIndex){case 0:e.index.showToast({title:"举报成功",icon:"success"});break;case 1:e.index.showToast({title:"已减少此类内容推荐",icon:"none"})}}})},g=async a=>{e.index.showModal({title:"提示",content:"确定要删除这条动态吗？",success:async function(o){if(o.confirm)try{const o=await t.momentApi.deleteMoment(a);if(200!==o.data.code)throw new Error(o.data.message||"删除失败");e.index.showToast({title:"删除成功",icon:"success"}),i.emitter.emit("updateSwimmerList"),e.index.switchTab({url:"/pages/swimmer/swimmer"})}catch(n){console.error("删除动态失败:",n),e.index.showToast({title:n.message||"删除失败",icon:"none"})}}})},f=()=>{d.value=null},p=e=>{const t=new Date(e),a=t.getHours().toString().padStart(2,"0"),o=t.getMinutes().toString().padStart(2,"0");return`${t.getMonth()+1}月${t.getDate()}日 ${a}:${o}`},x=()=>{m.value=!1},k=async()=>{try{JSON.parse(e.index.getStorageSync("userInfo")||"{}");let t;if(t=s.value.isFollowed?await o.userRelationsApi.unfollowUser(s.value.authorId):await o.userRelationsApi.followUser(s.value.authorId),200!==t.data.code&&201!==t.data.code)throw new Error(t.data.message||"操作失败");s.value.isFollowed=!s.value.isFollowed,i.emitter.emit("updateSwimmerList")}catch(t){console.error("关注操作失败:",t),e.index.showToast({title:t.message||"操作失败",icon:"none"})}},y=async()=>{try{const e=await t.momentApi.likeMoment(s.value.id);if(201!==e.data.code)throw new Error(e.data.message||"操作失败");{const{liked:t}=e.data.data;s.value.likes+=t?1:-1,s.value.isLiked=t,i.emitter.emit("updateSwimmerList")}}catch(a){console.error("点赞操作失败:",a),e.index.showToast({title:a.message||"操作失败",icon:"none"})}},S=()=>{e.index.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]})};return e.onLoad((a=>{a.id&&(l.value=a.id,r.value="true"===a.isFollowed,console.log(r.value),(async a=>{var o;try{const i=await t.momentApi.getMomentDetail(a),n=JSON.parse(e.index.getStorageSync("userInfo"))._id;if(200!==i.data.code)throw new Error(i.data.message||"获取动态详情失败");{const e=i.data.data;console.log(e),s.value={id:e._id,username:e.author.nickname,avatar:e.author.avatarUrl,authorId:e.author._id,location:e.location||"",content:e.content,images:e.images||[],isFollowed:r.value,isLiked:null==(o=e.likedBy)?void 0:o.includes(n),likes:e.likeCount,comments:e.commentCount,shares:e.shareCount||0}}}catch(i){console.error("获取动态详情失败:",i),e.index.showToast({title:i.message||"获取动态详情失败",icon:"none"})}})(a.id),v(a.id))})),e.onHide((()=>{i.emitter.emit("updateSwimmerList")})),(t,a)=>e.e({a:s.value.avatar,b:e.t(s.value.username),c:e.t(s.value.location),d:e.t(s.value.isFollowed?"已关注":"关注"),e:s.value.isFollowed?1:"",f:e.o(k),g:e.t(s.value.content),h:s.value.images&&s.value.images.length},s.value.images&&s.value.images.length?{i:e.f(s.value.images,((t,a,o)=>({a:a,b:t,c:e.o((t=>(t=>{e.index.previewImage({current:s.value.images[t],urls:s.value.images})})(a)),a)})))}:{},{j:s.value.isLiked?"/static/icons/moments-like-active.png":"/static/icons/moments-like.png",k:e.t(s.value.likes),l:e.o(y),m:e.t(s.value.comments),n:e.t(s.value.shares),o:e.o(S),p:e.o(w),q:e.f(c.value,((t,a,o)=>e.e({a:t.author.avatarUrl,b:!t.parentComment},t.parentComment?{d:e.t(t.author.nickname),e:e.t(t.parentComment.author.nickname)}:{c:e.t(t.author.nickname)},{f:e.t(p(t.createdAt)),g:e.t(t.content),h:e.o((e=>(e=>{d.value=e,m.value=!0})(t)),t._id),i:t._id}))),r:d.value?`回复 @${d.value.author.nickname}`:"说点什么吧...",s:m.value,t:e.o(x),v:u.value,w:e.o((e=>u.value=e.detail.value)),x:d.value},d.value?{y:e.o(f)}:{},{z:u.value.length>0?1:"",A:e.o(h)})}},s=e._export_sfc(n,[["__scopeId","data-v-6f63bffa"]]);wx.createPage(s);
