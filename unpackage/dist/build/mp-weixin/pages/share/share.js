"use strict";const e=require("../../common/vendor.js"),t={__name:"share",props:{distance:{type:Number,default:275},duration:{type:String,default:"1:13:41"},pace:{type:String,default:"26'47"},calories:{type:Number,default:99},poolLength:{type:Number,default:25},laps:{type:Number,default:11}},setup(t){const l=t,a=e.ref([{label:"总距离",key:"distance",checked:!0},{label:"总时间",key:"duration",checked:!0},{label:"配速",key:"pace",checked:!0},{label:"消耗热量",key:"calories",checked:!0},{label:"趟数",key:"laps",checked:!0},{label:"泳池长度",key:"poolLength",checked:!0}]),o=e.ref([{content:"在水里，才自由",selected:!0},{content:"享受失重 掌控自由",selected:!1},{content:"聚焦于动",selected:!1},{content:"水中的每一道阻力 都是你不竭的动力",selected:!1},{content:"相信自己的能力 你可以克服任何困难",selected:!1},{content:"你的坚持和毅力让我感到惊讶 是个令人敬佩的游泳高手",selected:!1}]),c=e.ref([{url:"/static/swimming.jpg",selected:!0},{url:"/static/swimming.jpg",selected:!1},{url:"/static/swimming.jpg",selected:!1}]),n=e.ref(null),s=e.ref(!1),i=e.ref(0),r=["数据","文案","图片"],u=e.computed((()=>[{label:"距离",value:l.distance,unit:"M"},{label:"时间",value:l.duration},{label:"平均配速",value:l.pace,unit:"/100m"},{label:"消耗热量",value:l.calories,unit:"KCAL"},{label:"泳池长度",value:l.poolLength,unit:"M"},{label:"趟数",value:l.laps}])),d=e.ref("position: fixed; left: -9999rpx;"),f=e.index.getSystemInfoSync().pixelRatio||2,v=()=>{s.value=!s.value},h=e=>{const t=a.value.find((t=>t.key===e));return!t||t.checked},p=e.computed((()=>{const e=o.value.find((e=>e.selected));return e?e.content:"在水里，才自由！"})),m=e.computed((()=>{var e;if(null==(e=n.value)?void 0:e.selected)return n.value.url;const t=c.value.find((e=>e.selected));return t?t.url:c.value[0].url})),x=()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album"],success:e=>{c.value.forEach((e=>e.selected=!1)),n.value={url:e.tempFilePaths[0],selected:!0}},fail:t=>{console.error("选择图片失败:",t),e.index.showToast({title:"选择图片失败",icon:"none"})}})},y=t=>new Promise(((l,a)=>{const o=e.index.createOffscreenCanvas({type:"2d"}).createImage();o.onload=()=>l(o),o.onerror=()=>a(new Error("图片加载失败")),o.src=t})),w=async()=>{try{const t=e.index.createSelectorQuery(),l=await new Promise((e=>{t.select("#shareCanvas").fields({node:!0,size:!0}).exec((t=>{var l;if(!(null==(l=t[0])?void 0:l.node))throw new Error("获取画布节点失败");e(t[0].node)}))})),o=l.getContext("2d");l.width=654*f,l.height=1e3*f,o.scale(f,f);const[c,n]=await Promise.all([y(m.value),y("/static/qr-code.jpg")]);o.fillStyle="#ffffff",o.fillRect(0,0,654,1e3),o.drawImage(c,0,0,654,400),o.fillStyle="#ffffff",o.font="bold 36px sans-serif",o.fillText(p.value,40,360),o.fillStyle="#333333",o.font="32px sans-serif",o.fillText("游泳数据",30,460);let s=0;return u.value.forEach(((e,t)=>{const l=a.value[t].key;if(h(l)){const t=30+s%2*220,l=530+100*Math.floor(s/2);if(o.font="bold 40px sans-serif",o.fillStyle="#333333",o.fillText(e.value.toString(),t,l),e.unit){const a=o.measureText(e.value.toString()).width;o.font="24px sans-serif",o.fillStyle="#666666",o.fillText(e.unit,t+a+10,l)}s++}})),o.fillStyle="#000000",o.fillRect(0,820,654,180),o.fillStyle="#ffffff",o.font="28px sans-serif",o.fillText("长按屏幕识别二维码",30,900),o.fillStyle="rgba(255,255,255,0.7)",o.font="24px sans-serif",o.fillText("加入焦动和我一起游泳",30,940),((e,t,l,a,o,c)=>{e.beginPath(),e.moveTo(t+c,l),e.lineTo(t+a-c,l),e.arcTo(t+a,l,t+a,l+c,c),e.lineTo(t+a,l+o-c),e.arcTo(t+a,l+o,t+a-c,l+o,c),e.lineTo(t+c,l+o),e.arcTo(t,l+o,t,l+o-c,c),e.lineTo(t,l+c),e.arcTo(t,l,t+c,l,c),e.closePath()})(o,504,850,120,120,12),o.clip(),o.drawImage(n,504,850,120,120),await new Promise(((t,a)=>{e.index.canvasToTempFilePath({canvas:l,success:e=>t(e.tempFilePath),fail:a})}))}catch(t){throw console.error("绘制失败:",t),t}},g=async()=>{try{e.index.showLoading({title:"生成图片中...",mask:!0}),await new Promise(((t,l)=>{e.index.authorize({scope:"scope.writePhotosAlbum",success:t,fail:()=>{e.index.showModal({title:"提示",content:"需要您授权保存图片到相册",success:a=>{a.confirm?e.index.openSetting({success:e=>{e.authSetting["scope.writePhotosAlbum"]?t():l(new Error("未获得权限"))}}):l(new Error("用户拒绝授权"))}})}})}));const t=await w();await e.index.saveImageToPhotosAlbum({filePath:t}),e.index.showToast({title:"保存成功",icon:"success"})}catch(t){console.error("保存失败:",t),e.index.showToast({title:t.message||"保存失败",icon:"error"})}finally{e.index.hideLoading()}},b=async()=>{try{await w()}catch(t){console.error("分享失败:",t),e.index.showToast({title:"分享失败",icon:"error"})}},T=()=>{e.index.showToast({title:"暂不支持QQ分享",icon:"none"})};return e.onMounted((()=>{const t=e.index.getSystemInfoSync();d.value=`position: fixed; left: -9999rpx; width: ${t.screenWidth}px; height: ${1.8*t.screenWidth}px;`})),(l,u)=>e.e({a:m.value,b:e.t(p.value),c:e.t(t.distance),d:h("distance"),e:e.t(t.duration),f:h("duration"),g:e.t(t.pace),h:h("pace"),i:e.t(t.calories),j:h("calories"),k:e.t(t.poolLength),l:h("poolLength"),m:e.t(t.laps),n:h("laps"),o:e.o(v),p:s.value},s.value?e.e({q:e.f(r,((t,l,a)=>({a:e.t(t),b:l,c:i.value===l?1:"",d:e.o((e=>(e=>{i.value=e})(l)),l)}))),r:0===i.value},0===i.value?{s:e.f(a.value,((t,l,o)=>({a:e.t(t.label),b:t.checked?1:"",c:l,d:e.o((t=>(t=>{const l=a.value.filter((e=>e.checked)).length;a.value[t].checked&&l<=3||a.value[t].checked&&l-1<3?e.index.showToast({title:"至少需要显示3项数据",icon:"none"}):a.value[t].checked=!a.value[t].checked})(l)),l)})))}:{},{t:1===i.value},1===i.value?{v:e.f(o.value,((t,l,a)=>({a:e.t(t.content),b:l,c:t.selected?1:"",d:e.o((e=>(e=>{o.value.forEach(((t,l)=>{t.selected=l===e}))})(l)),l)})))}:{},{w:2===i.value},2===i.value?{x:e.o(x),y:e.f(c.value,((t,l,a)=>e.e({a:t.url,b:t.selected},(t.selected,{}),{c:l,d:t.selected?1:"",e:e.o((e=>(e=>{c.value.forEach((e=>e.selected=!1)),n.value&&(n.value.selected=!1),c.value[e].selected=!0})(l)),l)})))}:{},{z:0===i.value},(i.value,{})):{},{A:e.o(g),B:e.o(b),C:e.o(T),D:e.s(d.value)})}},l=e._export_sfc(t,[["__scopeId","data-v-73cb4fda"]]);wx.createPage(l);
