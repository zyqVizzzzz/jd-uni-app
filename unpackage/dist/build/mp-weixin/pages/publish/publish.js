"use strict";const e=require("../../common/vendor.js"),o=require("../../api/moments.js"),t=require("../../config.js"),a=require("../../utils/eventBus.js");require("../../utils/require.js");const i={__name:"publish",setup(i){const n=e.ref(""),r=e.ref([]),s=e.computed((()=>n.value.trim()||r.value.length>0)),l=()=>{e.index.chooseImage({count:9-r.value.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{r.value=[...r.value,...e.tempFilePaths]},fail:()=>{e.index.showToast({title:"选择图片失败",icon:"none"})}})},c=async()=>{if(s.value)try{e.index.showLoading({title:"发布中..."});let s=[];if(r.value.length>0)try{const o=e.index.getStorageSync("token");for(const a of r.value){const i=await new Promise(((i,n)=>{e.index.uploadFile({url:`${t.config.API_BASE_URL}/moments/upload`,filePath:a,name:"images",header:{Authorization:`Bearer ${o}`},success:e=>{try{const o=JSON.parse(e.data);i(o)}catch(o){n(new Error("解析响应失败"))}},fail:e=>{n(e)}})}));if(console.log(i.code),201!==i.code)throw new Error("图片上传失败");s.push(i.data.imageUrls[0])}}catch(i){throw console.error("图片上传失败:",i),e.index.showToast({title:"图片上传失败",icon:"none"}),i}console.log(s);const l=await o.momentApi.createMoment({content:n.value.trim(),images:s});if(201!==l.data.code)throw new Error(l.data.message||"发布失败");e.index.hideLoading(),a.emitter.emit("updateSwimmerList"),e.index.reLaunch({url:"/pages/swimmer/swimmer"})}catch(i){console.error("发布失败:",i),e.index.hideLoading(),e.index.showToast({title:i.message||"发布失败",icon:"none"})}};return(o,t)=>e.e({a:n.value,b:e.o((e=>n.value=e.detail.value)),c:e.f(r.value,((e,o,t)=>({a:e,b:o}))),d:r.value.length<9},r.value.length<9?{e:e.o(l)}:{},{f:!s.value,g:e.o(c)})}};wx.createPage(i);
