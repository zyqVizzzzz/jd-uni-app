"use strict";const e=require("../../common/vendor.js"),t=require("../../api/moments.js"),a=require("../../api/userRelations.js"),o=require("../../utils/eventBus.js");require("../../utils/require.js"),require("../../config.js");const s={__name:"swimmer",setup(s){const i=[{text:"推荐",type:"all"},{text:"关注",type:"following"},{text:"我的",type:"my"}],n=i.map((e=>e.text)),r=e.ref(0),l=e.ref([]),c=e.ref(!1),d=e.ref(!1),u=e.ref(1),m=async(a=!1)=>{try{a&&(u.value=1),console.log(u.value);const o={page:Number(u.value),limit:Number(20),type:i[r.value].type},s=await t.momentApi.getMoments(o),n=JSON.parse(e.index.getStorageSync("userInfo"))._id;if(200!==s.data.code)throw new Error(s.data.message||"获取动态列表失败");{const e=s.data.data.items.map((e=>{var t,a,o;return{id:e._id,username:e.author.nickname,authorId:e.author._id,avatar:e.author.avatarUrl,createTime:new Date(e.createdAt).toLocaleDateString("zh-CN"),content:e.content,image:(null==(t=e.images)?void 0:t[0])||"",images:e.images||[],isFollowed:e.author.isFollowing,isLiked:null==(a=e.likedBy)?void 0:a.includes(n),likes:e.likeCount,comments:e.commentCount,shares:0,sportData:null==(o=e.metadata)?void 0:o.sportData}}));l.value=a?e:[...l.value,...e],u.value++}}catch(o){console.error("获取动态列表失败:",o),e.index.showToast({title:o.message||"获取动态列表失败",icon:"none"})}},g=async()=>{d.value=!0;try{await m(!0)}catch(e){console.error("刷新失败:",e)}finally{d.value=!1}},h=async()=>{if(!c.value){c.value=!0;try{await m()}finally{c.value=!1}}},w=async a=>{e.index.showModal({title:"提示",content:"确定要删除这条动态吗？",success:async function(o){if(o.confirm)try{const o=await t.momentApi.deleteMoment(a);if(200!==o.data.code)throw new Error(o.data.message||"删除失败");l.value=l.value.filter((e=>e.id!==a)),e.index.showToast({title:"删除成功",icon:"success"})}catch(s){console.error("删除动态失败:",s),e.index.showToast({title:s.message||"删除失败",icon:"none"})}}})},p=()=>{e.index.navigateTo({url:"/pages/publish/publish"})},v=(t,a)=>{e.index.navigateTo({url:`/pages/swimmerDetail/swimmerDetail?id=${t}&isFollowed=${a}`})};return e.onMounted((()=>{m(!0),o.emitter.on("updateSwimmerList",(()=>{console.log("收到更新事件"),m(!0)}))})),(o,s)=>e.e({a:e.f(e.unref(n),((t,a,o)=>({a:e.t(t),b:a,c:r.value===a?1:"",d:e.o((e=>(e=>{r.value=e,g()})(a)),a)}))),b:e.f(l.value,((o,s,i)=>e.e({a:o.avatar,b:e.t(o.username),c:e.t(o.createTime),d:e.t(o.isFollowed?"已关注":"关注"),e:o.isFollowed?1:"",f:e.o((t=>(async t=>{console.log(t);try{let o;JSON.parse(e.index.getStorageSync("userInfo")||"{}"),o=t.isFollowed?await a.userRelationsApi.unfollowUser(t.authorId):await a.userRelationsApi.followUser(t.authorId),200!==o.data.code&&201!==o.data.code||(console.log(l.value),l.value=l.value.map((e=>e.authorId===t.authorId?{...e,isFollowed:!e.isFollowed}:e)))}catch(o){console.error("关注操作失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}})(o)),s),g:e.t(o.content),h:o.images&&o.images.length>0},o.images&&o.images.length>0?{i:e.f(o.images,((t,a,s)=>({a:t,b:a,c:e.o((t=>{return a=o.images,void e.index.previewImage({urls:[a]});var a}),a)}))),j:e.n(1===o.images.length?"single-image":""),k:e.n(4===o.images.length?"four-grid":""),l:e.n(o.images.length>4?"multi-grid":"")}:{},{m:o.sportData},o.sportData?{n:e.t(o.sportData.distance),o:e.t(o.sportData.duration),p:e.t(o.sportData.pace),q:e.t(o.sportData.calories)}:{},{r:e.o((e=>v(o.id,o.isFollowed)),s),s:o.isLiked?"/static/icons/moments-like-active.png":"/static/icons/moments-like.png",t:e.t(o.likes),v:e.o((a=>(async a=>{try{const e=await t.momentApi.likeMoment(a.id);if(201!==e.data.code)throw new Error(e.data.message||"操作失败");{const{liked:t}=e.data.data;l.value=l.value.map((e=>e.id===a.id?{...e,likes:e.likes+(t?1:-1),isLiked:t}:e))}}catch(o){console.error("点赞操作失败:",o),e.index.showToast({title:o.message||"操作失败",icon:"none"})}})(o)),s),w:e.t(o.comments),x:e.o((e=>v(o.id,o.isFollowed)),s),y:e.t(o.shares),z:e.o((t=>{e.index.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]})}),s),A:e.o((t=>(t=>{const a=JSON.parse(e.index.getStorageSync("userInfo"))._id,o=t.authorId===a,s=o?["删除"]:["举报","不感兴趣"];e.index.showActionSheet({itemList:s,success:async function(a){if(o)switch(a.tapIndex){case 0:try{await w(t.id)}catch(s){console.error("删除动态失败:",s)}break;case 1:e.index.showToast({title:"举报成功",icon:"success"})}else switch(a.tapIndex){case 0:e.index.showToast({title:"举报成功",icon:"success"});break;case 1:e.index.showToast({title:"已减少此类内容推荐",icon:"none"})}}})})(o)),s),B:s}))),c:c.value},(c.value,{}),{d:e.o(h),e:d.value,f:e.o(g),g:e.o(p)})}},i=e._export_sfc(s,[["__scopeId","data-v-42d9b6f4"]]);wx.createPage(i);
