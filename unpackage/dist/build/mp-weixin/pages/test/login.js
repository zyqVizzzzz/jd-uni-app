"use strict";const e=require("../../common/vendor.js"),o=require("../../config.js"),t=e.defineComponent({__name:"login",setup(t){const a=e.ref(!1),n=e.ref(!1),s=e.ref(""),r=e.ref(null),l=o.config.API_BASE_URL,c=async()=>{try{a.value=!0;const o=await e.index.login({provider:"weixin"});console.log("微信登录成功",o);const t=await e.index.request({url:`${l}/auth/login`,method:"POST",data:{code:o.code}});if(console.log("后端登录成功",t),201!==t.statusCode||!t.data.access_token)throw new Error("登录失败");s.value=t.data.access_token,n.value=!0,r.value=t.data.user,e.index.setStorageSync("token",t.data.access_token),e.index.showToast({title:"登录成功",icon:"success"})}catch(o){console.error("登录错误",o),e.index.showToast({title:"登录失败",icon:"error"})}finally{a.value=!1}},u=async()=>{try{const o=await e.index.getUserProfile({desc:"用于完善用户资料"});console.log("获取用户信息成功",o);const t=await e.index.request({url:`${l}/auth/update-userinfo`,method:"POST",data:o.userInfo,header:{Authorization:`Bearer ${s.value}`}});console.log("更新用户信息成功",t),200===t.statusCode&&(r.value=t.data,e.index.showToast({title:"更新成功",icon:"success"}))}catch(o){console.error("获取用户信息错误",o),e.index.showToast({title:"获取信息失败",icon:"error"})}};return e.onMounted((()=>{const o=e.index.getStorageSync("token");o&&(s.value=o,n.value=!0)})),(o,t)=>e.e({a:e.t(n.value?"已登录":"未登录"),b:e.n(n.value?"success":"default"),c:s.value},s.value?{d:e.t(s.value)}:{},{e:r.value},r.value?{f:e.t(JSON.stringify(r.value,null,2))}:{},{g:e.t(a.value?"登录中...":"测试登录"),h:e.o(c),i:a.value,j:n.value},n.value?{k:e.o(u)}:{})}});wx.createPage(t);
