"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/require.js"),a=require("../../config.js"),n=require("../../utils/eventBus.js"),o={__name:"profile",setup(o){const i=e.ref({}),r=["未设置","男","女"],c=e.ref(["","",""]),l=Array.from({length:171},((e,t)=>`${t+30}kg`)),s=e.computed((()=>i.value.weight&&l.findIndex((e=>parseInt(e)===i.value.weight))||20)),u=Array.from({length:151},((e,t)=>`${t+100}cm`)),d=e.computed((()=>i.value.height&&u.findIndex((e=>parseInt(e)===i.value.height))||70)),h=["北京市","上海市","天津市","重庆市"],v=e.computed((()=>{const{province:e,city:t}=i.value;return e||t?h.includes(e)?e.replace("",""):`${t}`.trim():"未设置"})),m=e=>{const[t,a,n]=e.detail.value,[o,i,r]=e.detail.code||[];x({province:t,city:a,district:n,provinceCode:null==o?void 0:o.toString(),cityCode:null==i?void 0:i.toString(),districtCode:null==r?void 0:r.toString()})},g=e=>{const t=new Date;let a=t.getFullYear(),n=t.getMonth()+1,o=t.getDate();return"start"===e?a-=100:"end"===e||"default"===e&&(a=2e3),n=n>9?n:"0"+n,o=o>9?o:"0"+o,`${a}-${n}-${o}`},p=e.computed((()=>i.value.birthday||g("default"))),f=e.computed((()=>g("start"))),y=e.computed((()=>g("end")));e.onMounted((()=>{w()}));const w=async()=>{try{const a=await t.request({url:"/users/me"});if(200===a.data.code){const t=a.data.data;i.value=t,e.index.setStorageSync("userInfo",JSON.stringify(t)),t.province&&t.city&&(c.value=[t.province,t.city,t.district||""])}}catch(a){console.error("获取用户信息失败:",a)}},x=async a=>{try{201===(await t.request({url:"/users/me",method:"POST",data:a})).data.code&&(n.emitter.emit("updateUserInfo"),w())}catch(o){e.index.showToast({title:"更新失败",icon:"none"})}},b=()=>{e.index.showModal({title:"修改昵称",editable:!0,placeholderText:"请输入昵称",content:i.value.nickname||"",success:function(e){e.confirm&&e.content&&x({nickname:e.content})}})},I=async()=>{try{const t=await e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"]});if(t.tempFilePaths&&t.tempFilePaths[0]){const e=t.tempFilePaths[0];await S(e)}}catch(t){console.error("选择图片失败:",t),e.index.showToast({title:"选择图片失败",icon:"none"})}},S=async t=>{try{e.index.showLoading({title:"上传中..."});const o=await e.index.uploadFile({url:`${a.config.API_BASE_URL}/users/me/avatar`,filePath:t,name:"avatar",header:{Authorization:`Bearer ${e.index.getStorageSync("token")}`}});if(e.index.hideLoading(),!o.data.includes("201"))throw new Error("上传失败");n.emitter.emit("updateUserInfo"),await w()}catch(o){e.index.hideLoading(),console.error("上传头像失败:",o),e.index.showToast({title:"上传失败",icon:"none"})}},T=()=>{e.index.showModal({title:"修改简介",editable:!0,placeholderText:"请输入简介",content:i.value.bio||"",success:function(e){e.confirm&&e.content&&x({bio:e.content})}})},$=async a=>{if("getPhoneNumber:ok"===a.detail.errMsg)try{201===(await t.request({url:"/users/me",method:"POST",data:{code:a.detail.code}})).data.code&&(e.index.showToast({title:"手机号绑定成功",icon:"success"}),w())}catch(n){e.index.showToast({title:"手机号绑定失败",icon:"none"})}},q=e=>{const t=parseInt(e.detail.value);x({gender:t})},P=e=>{x({birthday:e.detail.value})},k=e=>{const t=parseInt(l[e.detail.value]);x({weight:t})},A=e=>{const t=parseInt(u[e.detail.value]);x({height:t})};return(t,a)=>e.e({a:i.value.avatarUrl||"/static/avatar-default@3x.png",b:e.o(I),c:e.t(i.value.nickname||"未设置"),d:e.o(b),e:e.t(i.value.bio||"未设置"),f:e.o(T),g:!i.value.phone},i.value.phone?{}:{h:e.o($)},{i:e.t(r[i.value.gender]||"未设置"),j:e.o(q),k:i.value.gender||0,l:r,m:e.t(i.value.birthday||"未设置"),n:i.value.birthday||p.value,o:f.value,p:y.value,q:e.o(P),r:e.t(i.value.weight?`${i.value.weight}kg`:"未设置"),s:e.o(k),t:s.value,v:e.unref(l),w:e.t(i.value.height?`${i.value.height}cm`:"未设置"),x:e.o(A),y:d.value,z:e.unref(u),A:e.t(v.value),B:e.o(m),C:c.value})}};wx.createPage(o);
